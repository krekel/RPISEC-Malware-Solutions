Malware Analysis
Fall 
Lab 04 ­ Debugging Concepts and Tools

**Lab_04­1.malware**

This sample uses an anti­analysis technique that we will discuss later on in the course. The
anti­analysis technique makes static analysis harder. Using dynamic analysis is highly
recommended!

1. (5%) Set a breakpoint at 0x00401092, what is this this sample calling?
    
    The sample is calling GetProcAddress

2. (5%) What is being called at 0x004010A6? What is the callee doing?
    
    VirtualAlloc. Allocating 0xb000 bytes at memory location 0xc000000 with read/write access.

3. (5%) What is sub_401360 doing? What about sub_401372 and sub_401388?

    * sub_401360: resolves addresses for kernel32.dll functions.
    
    * sub_401372: resolves addresses for adv32api.dll functions.
    
    * sub_401388: resolves addresses for user32.dll functions

4. (15%) What Windows API functions did the sample import?

    GetProcAddress, VirtualAlloc, GetModuleFileName,CopyFile, ExitProcess, GetWindowsDirectoryA, LoadLibraryA, RegCreateKeyA, RegSetkeyValueA, RegCloseKeyA, MessageBoxA


5. (10%) How did you find the Imported functions?

    Converting the arguments to characters being passed to sub_401360, sub_401372, sub_401388

6. (10%) What does this sample do?

    The sample dynamically contructs its import table using the image base of kernel32.dll, adv32api.dll, user32.dll. It then copies itself as virus.exe at C:\Windows\virus.exe and displays a message box with the message 'Infected!'.



**Lab_04­2.malware**

1. (5%) What is the address of the win/lose function?

    sub_401180

2. (15%) What does this sample do with the user input?
    
    Shifts the nibbles and the xored each byte of the input against '{ga1F_1auTca_eht_t0n_s!_s1hT}galf'

3. (10%) What is the address of the encrypted flag?

    sub_40303C

4. (20%) Flag? :­)
    f l a g { P r a 1 s e _ t h 3 _ S u n ! }


script
```python

def shift(char):
    al = char
    cl = al
    al = (al >> 4) & (0x000000ff)
    cl = cl << 4 & (0x000000ff)
    cl |= al
    return chr(cl)

def main():
    xored = []
    enc_flag = [0x1d, 0xa1, 0x77, 0x47, 0xf1, 0x5a, 0x16, 0x77, 0x66, 0x63, 0x35, 0x94, 0x18, 0xe3, 0x5b, 0x81, 0x6a, 0x23, 0xd6, 0x7c, 0x88]
    key = 'flag}Th1s_!s_n0t_the_acTua1_F1ag{'[::-1]
    print(key)

    for i, c in enumerate(enc_flag):
        xored.append(c ^ ord(key[i]))

    flag = list(map(lambda c: shift(c), xored))

    print(''.join(flag))

if __name__ == "__main__":
    main()

```

Malware Analysis

Fall 2015

Lab 03 ­ Analyzing Windows Programs

# Lab\_03­1.malware

Shiela from marketing has been complaining about random popups. She claims she didn&#39;t do anything but we think she clicked on another &quot;link&quot; in her email again. Can you find out if we need to be worried?

** **

1. (1 pts) Did you find any interesting resources? If so, how did you extract it?

	One interesting resource was found. IDR_DLL1, a dll.
	The resource was extracted using ResourceHacker

1. (3 pts) List at least 3 imports or sets of imports. What is their purpose (from msdn), and how might the malware use them?

	LoadResource: loads the dll from the resource section.
	WriteFile: Once the dll is loaded from the resource section, the malware writes the dll on the victim's machine.
	IsDebuggerPresent: Anti debugging technique to slow down the analysis process.

1. (3 pts) List at least 3 strings that stick out to you and describe how they might relate to malicious activity.
	
	regsvr32 /s C:\\Windows\\atidvr.dll: register the dll as a command component in the registry. 
	http://rpis.ec/ - one of few potential network signatures found
	C:\Users\IEUser\Downloads\BHOinCPP_src\BHOinCPP\Release\BHOinCPP.pbd: It seems that it is a project hosted at codeproject.com


1. (3 pts) What persistence mechanism is used by this malware? What host­based signatures can you gather from this?

	regsvr32 -> Registers the dll loaded with regsvr32 /s C:\\Windows\\atidvr.dll
	
	CLSID\{3543619C-D563-43f7-95EA-4DA7E1CC396A}\InProcServer32
	Software\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects\{3543619C-D563-43f7-95EA-4DA7E1CC396A}
	
** **

1. (2 pts) What is the CLSID served by this malware?

	CLSID\{3543619C-D563-43f7-95EA-4DA7E1CC396A}	

1. (2 pts) What is the name of the COM interface that this malware makes use of?
	
	IWebBrowser2

1. (2 pts) What two COM functions does this malware call from the above COM interface, and what are they used for? (hint: check the PMA book)

	put_Visible: shows the windows explorer instance
	Navigate: Navigates to a resource identified by an url.
	
	It chooses one of the few rpisec urls to use in adware


# Lab\_03­2.malware

The networking guys noticed a bunch of weird activity coming from a box on your network and had IT do an in­depth scan. This was the only file of interest, what can you tell us?

# Basic Analysis

1. (1 pts) What is the md5sum? What of interest does VirusTotal Report?
	
	bf4f5b4ff7ed9c7275496c07f9836028
	Makes a request to us.t28.net
	Writes a file to C:\Users\Administrator\java.exe
	Shell command execution	

1. (3 pts) List at least 3 imports or sets of imports you haven&#39;t seen before, what is their purpose (from msdn), and how might the malware use them.
	GetOEMCP: VM detection.
	GetLogicalDrives: Enumerates all mapped drives.
	GetHostByName: Resolve an attackers host for establishing communications.

** **

1. (3 pts) List at least 3 strings that stick out to you and describe how they might relate to malicious activity.
	upfileok, upfileer - malware may have the ability to upload the victim's file to the attackers server.
	cmd.exe - opens a console for remote code execution
	SOFTWARE\Microsoft\Windows\CurrentVersion\Run - Persistance mechanism
	\java.exe - possible file drop
	
	While searching for possible strings I stumbled upon an analysis of APT 1. Interesting...
** **

1. (3 pts) What persistence mechanism is used by this malware? What host­based signatures can you gather from this?
	Registry persistance
	SOFTWARE\Microsoft\Windows\CurrentVersion\Run - C:\DOCUMENT~1\me\java.exe	

	Host-based signatures:
	C:\DOCUMENT~1\me\java.exe


# Advanced Analysis

The networking guys gave you some more information about the traffic that tipped them off. They were able to extrapolate from the traffic and identify some functionality they want you to look into. Answer the following questions (5­8) for each of the functions identified by the networking team.

Identified functionality

        List processes, interactive remote shell, upload file (from infected machine)


# List processes
1. (1 pts) What is the address of the subroutine that handles this functionality?
	
	0x00402310

2. (1 pts) What is the command ID? It will help the networking guys group the traffic.

	Command id: 0x7

3. (1pts) Does the subroutine return anything to the attacker, if so, what?

	Returns the list of running processes in the victim's computer

4. (3 pts) Name 3 Windows API calls used and how they contribute to the functionality. **(send/recv don&#39;t count!)**

	CreateToolhelp32Snapshot - takes a snapshow of all running processes
	Process32First - retrieves information about the first process
	Process32Next - continue iterating through the process snapshot


# Interactive remote shell
1. (1 pts) What is the address of the subroutine that handles this functionality?

	0x00402050

2. (1 pts) What is the command ID? It will help the networking guys group the traffic.

	Command id: 0x3

3. (1pts) Does the subroutine return anything to the attacker, if so, what?

	Returns the result of the executed command

4. (3 pts) Name 3 Windows API calls used and how they contribute to the functionality. **(send/recv don&#39;t count!)**

	WinExec - runs the specified application

# Upload file
1. (1 pts) What is the address of the subroutine that handles this functionality?

	0x004020f0
	
2. (1 pts) What is the command ID? It will help the networking guys group the traffic.

	0x5

3. (1pts) Does the subroutine return anything to the attacker, if so, what?

	Returns the file that was uploaded from the victim's machine.

4. (3 pts) Name 3 Windows API calls used and how they contribute to the functionality. **(send/recv don&#39;t count!)**

	CreateFile - Opens an I/O connection
	WriteFile - Writes to an open I/O connection

** **
5. (3 pts) Did the networking guys miss anything? Briefly name/describe 3 more functionalities offered by the malware. Provide the command IDs.

	Maps all logical disks and their types - 0x1
	Delete Files remotely - 0x4
	Create Files remotely - 0x6
	Terminates processes - 0x8